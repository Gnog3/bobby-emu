use std::sync::mpsc::Sender;

use anyhow::{Result, bail};

use crate::{csrs::Csr, display::DisplayEvent};

#[rustfmt::skip]
const FONT: &[&[(u8, u8)]] = &[
    &[],
    &[(2, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 6)],
    &[(1, 0), (3, 0), (1, 1), (3, 1)],
    &[(1, 0), (3, 0), (1, 1), (3, 1), (0, 2), (1, 2), (2, 2), (3, 2), (4, 2), (1, 3), (3, 3), (0, 4), (1, 4), (2, 4), (3, 4), (4, 4), (1, 5), (3, 5), (1, 6), (3, 6)],
    &[(2, 0), (1, 1), (2, 1), (3, 1), (4, 1), (0, 2), (2, 2), (1, 3), (2, 3), (3, 3), (2, 4), (4, 4), (0, 5), (1, 5), (2, 5), (3, 5), (2, 6)],
    &[(0, 0), (1, 0), (0, 1), (1, 1), (4, 1), (3, 2), (2, 3), (1, 4), (0, 5), (3, 5), (4, 5), (3, 6), (4, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (3, 1), (0, 2), (2, 2), (1, 3), (0, 4), (2, 4), (4, 4), (0, 5), (3, 5), (1, 6), (2, 6), (4, 6)],
    &[(2, 0), (2, 1)],
    &[(3, 0), (2, 1), (1, 2), (1, 3), (1, 4), (2, 5), (3, 6)],
    &[(1, 0), (2, 1), (3, 2), (3, 3), (3, 4), (2, 5), (1, 6)],
    &[(0, 1), (2, 1), (4, 1), (1, 2), (2, 2), (3, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 3), (1, 4), (2, 4), (3, 4), (0, 5), (2, 5), (4, 5)],
    &[(2, 1), (2, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 3), (2, 4), (2, 5)],
    &[(2, 4), (2, 5), (1, 6)],
    &[(0, 3), (1, 3), (2, 3), (3, 3), (4, 3)],
    &[(2, 6)],
    &[(4, 1), (3, 2), (2, 3), (1, 4), (0, 5)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (3, 2), (4, 2), (0, 3), (2, 3), (4, 3), (0, 4), (1, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(2, 0), (1, 1), (2, 1), (0, 2), (2, 2), (2, 3), (2, 4), (2, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (4, 2), (3, 3), (2, 4), (1, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (4, 2), (2, 3), (3, 3), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(2, 0), (3, 0), (1, 1), (3, 1), (0, 2), (3, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 3), (3, 4), (3, 5), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (0, 1), (0, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 4), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (0, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (4, 1), (3, 2), (2, 3), (1, 4), (1, 5), (1, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (1, 3), (2, 3), (3, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (1, 3), (2, 3), (3, 3), (4, 3), (4, 4), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(2, 1), (2, 5)],
    &[(2, 1), (2, 4), (2, 5), (1, 6)],
    &[(3, 1), (2, 2), (1, 3), (2, 4), (3, 5)],
    &[(0, 2), (1, 2), (2, 2), (3, 2), (4, 2), (0, 4), (1, 4), (2, 4), (3, 4), (4, 4)],
    &[(1, 1), (2, 2), (3, 3), (2, 4), (1, 5)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (3, 3), (2, 4), (2, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (2, 2), (3, 2), (4, 2), (0, 3), (2, 3), (4, 3), (0, 4), (2, 4), (3, 4), (4, 4), (0, 5), (1, 6), (2, 6), (3, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (0, 3), (0, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (0, 1), (0, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (0, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (0, 1), (0, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (0, 5), (0, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (0, 3), (0, 4), (3, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (1, 3), (2, 3), (3, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (4, 1), (4, 2), (4, 3), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (3, 2), (0, 3), (1, 3), (2, 3), (0, 4), (3, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (0, 1), (0, 2), (0, 3), (0, 4), (0, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(0, 0), (4, 0), (0, 1), (1, 1), (3, 1), (4, 1), (0, 2), (2, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (1, 2), (4, 2), (0, 3), (2, 3), (4, 3), (0, 4), (3, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (0, 5), (0, 6)],
    &[(1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (2, 4), (4, 4), (0, 5), (3, 5), (1, 6), (2, 6), (4, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (1, 3), (2, 3), (3, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(1, 0), (2, 0), (3, 0), (4, 0), (0, 1), (0, 2), (1, 3), (2, 3), (3, 3), (4, 4), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (2, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (1, 5), (3, 5), (2, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (2, 4), (4, 4), (0, 5), (1, 5), (3, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (1, 2), (3, 2), (2, 3), (1, 4), (3, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (4, 0), (0, 1), (4, 1), (1, 2), (3, 2), (2, 3), (2, 4), (2, 5), (2, 6)],
    &[(0, 0), (1, 0), (2, 0), (3, 0), (4, 0), (4, 1), (3, 2), (2, 3), (1, 4), (0, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(2, 0), (3, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (2, 6), (3, 6)],
    &[(0, 1), (1, 2), (2, 3), (3, 4), (4, 5)],
    &[(1, 0), (2, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (1, 6), (2, 6)],
    &[(2, 0), (1, 1), (3, 1)],
    &[(0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(1, 0), (2, 1)],
    &[(1, 2), (2, 2), (3, 2), (4, 3), (1, 4), (2, 4), (3, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(0, 0), (0, 1), (0, 2), (1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(4, 0), (4, 1), (1, 2), (2, 2), (3, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (1, 4), (2, 4), (3, 4), (4, 4), (0, 5), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(2, 0), (3, 0), (1, 1), (0, 2), (1, 2), (2, 2), (3, 2), (4, 2), (1, 3), (1, 4), (1, 5), (1, 6)],
    &[(1, 2), (2, 2), (3, 2), (4, 2), (0, 3), (4, 3), (1, 4), (2, 4), (3, 4), (4, 4), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (0, 1), (0, 2), (1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(2, 0), (0, 2), (1, 2), (2, 2), (2, 3), (2, 4), (2, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(4, 0), (2, 2), (3, 2), (4, 2), (4, 3), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 0), (0, 1), (0, 2), (3, 2), (0, 3), (1, 3), (2, 3), (0, 4), (3, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 0), (0, 1), (0, 2), (0, 3), (0, 4), (0, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 2), (1, 2), (3, 2), (0, 3), (2, 3), (4, 3), (0, 4), (2, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(0, 2), (1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (0, 6), (4, 6)],
    &[(1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 2), (1, 2), (2, 2), (3, 2), (0, 3), (4, 3), (0, 4), (1, 4), (2, 4), (3, 4), (0, 5), (0, 6)],
    &[(1, 2), (2, 2), (3, 2), (4, 2), (0, 3), (4, 3), (1, 4), (2, 4), (3, 4), (4, 4), (4, 5), (4, 6)],
    &[(0, 2), (2, 2), (3, 2), (0, 3), (1, 3), (4, 3), (0, 4), (0, 5), (0, 6)],
    &[(1, 2), (2, 2), (3, 2), (4, 2), (0, 3), (1, 4), (2, 4), (3, 4), (4, 5), (0, 6), (1, 6), (2, 6), (3, 6)],
    &[(1, 0), (1, 1), (0, 2), (1, 2), (2, 2), (3, 2), (1, 3), (1, 4), (1, 5), (4, 5), (2, 6), (3, 6)],
    &[(0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (4, 5), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (1, 5), (3, 5), (2, 6)],
    &[(0, 2), (4, 2), (0, 3), (4, 3), (0, 4), (4, 4), (0, 5), (2, 5), (4, 5), (1, 6), (3, 6)],
    &[(0, 2), (4, 2), (1, 3), (3, 3), (2, 4), (1, 5), (3, 5), (0, 6), (4, 6)],
    &[(0, 2), (4, 2), (0, 3), (4, 3), (1, 4), (2, 4), (3, 4), (4, 4), (4, 5), (1, 6), (2, 6), (3, 6)],
    &[(0, 2), (1, 2), (2, 2), (3, 2), (4, 2), (3, 3), (2, 4), (1, 5), (0, 6), (1, 6), (2, 6), (3, 6), (4, 6)],
    &[(3, 0), (2, 1), (2, 2), (1, 3), (2, 4), (2, 5), (3, 6)],
    &[(2, 0), (2, 1), (2, 2), (2, 3), (2, 4), (2, 5), (2, 6)],
    &[(1, 0), (2, 1), (2, 2), (3, 3), (2, 4), (2, 5), (1, 6)],
    &[(1, 2), (4, 2), (0, 3), (2, 3), (3, 3)],
];

pub struct CharacterPrinterCsr {
    send: Sender<DisplayEvent>,
    length: usize,
    target_x: u16,
    target_y: u16,
    color: u32,
}

impl CharacterPrinterCsr {
    pub fn new(send: Sender<DisplayEvent>) -> Self {
        Self {
            send,
            length: 0,
            target_x: 0,
            target_y: 0,
            color: 0,
        }
    }

    pub fn send_char(&mut self, c: u8) {
        if !(c >= 0x20 && c < 0x7F) {
            self.target_x += 6;
            return;
        }

        let c = (c - 0x20) as usize;
        let pixels = FONT[c as usize];
        let mut matrix = 0u64;
        for &(x, y) in pixels {
            let idx = y * 8 + x;
            matrix |= 1 << idx;
        }
        self.send
            .send(DisplayEvent::Matrix {
                matrix,
                target_x: self.target_x,
                target_y: self.target_y,
                color: self.color,
            })
            .unwrap();
        self.target_x += 6;
    }
}

impl Csr for CharacterPrinterCsr {
    fn read(&mut self, _csr: u32, _ram: &mut [u8]) -> Result<u32> {
        bail!("Can't read from character printer")
    }

    fn write(&mut self, csr: u32, ram: &mut [u8], data: u32) -> Result<()> {
        match csr {
            1024 => self.color = data,
            1025 => {
                self.target_x = (data & 0xFFFF) as u16;
                self.target_y = (data >> 16) as u16;
            }
            1026 => {
                let addr = data as usize;
                let data = &ram[addr..addr + self.length];
                for c in data {
                    self.send_char(*c);
                }
            }
            1037 => self.length = data as usize,
            _ => unreachable!(),
        }
        Ok(())
    }
}
